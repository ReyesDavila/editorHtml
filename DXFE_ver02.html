<!DOCTYPE html>
<html lang="es">
    <head> 
        <title>DXFE</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes">
        <link rel="shortcut icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAvElEQVRYR+2WUQ6AMAhDx/0PjdnHEpzCYMFijP66rS91tFIrfqhYv70LgJl5OEJEELiTiAegr8mECwEMwBIAjzs7F9rlgBTfEZn3SAeXANniHSYE0DdkQ4QBZoiSSyghygAGRClAxhTIM5ZTkC14GcmnBVbnQwrHgoABaFH+LQCrqiEOWHUNBZgLx4pyNQdW4+N5LxPT5UB260knSgDCDnhstdZYv20uB7IA7toSBqBVNQRg5/PAoliD+wEOXE+oIYUeBr0AAAAASUVORK5CYIIA">
    </head>
    <body> 
        <style>
            body{    
		/*border: 1px solid red;*/
                background-color: rgb(20, 19, 19);
                color: white;
                height: calc(100vh - 2px);
                margin: 0px;
                padding: 0px;
                position: relative;
                font-family: 'Courier New', Courier, monospace;
                overflow: hidden;
            }

            #contenedor_principal{
                /*border: 1px solid blue;*/
                display: flex;
                overflow: scroll;
                height: calc(100% - 2px);
                margin: 0px;
                overflow:hidden;
            }

            #contenedor_textarea{
                /*border: 1px solid green;*/
                width: calc(100% - 2px);
                height: calc(100% - 2px);
                margin: 0px;
                overflow: auto;
                padding: 0px;
            }

            textarea{
                /*border: 1px solid blue;*/
                border-width: 0px;
                border-style: none;
                background: rgb(20, 19, 19);
                color: white;
                resize: none;
                padding: 0px;
                padding-top: 32px;
                padding-left: 54px;
                margin: 0px;
                overflow: hidden;
                white-space: nowrap;
                min-width: calc(100% - 2px - 54px);
                min-height: calc(100% - 32px - 7px);
                font-size: 16px;
                font-family:'Courier New', Courier, monospace;
            }

            textarea:focus {
                outline: none;
            }

            #enumerador_textarea{
                padding: 5px;
                padding-top: 32px;
                background: rgba(27, 26, 26, 0.9);
                width: calc(54px - 10px);
                height: calc(100% - 2px);
                font-size: 16px;
                font-family:'Courier New', Courier, monospace;
                font-style: normal;
                text-align: right;
                overflow: hidden;
                user-select: none;
                position: absolute;
                top: 0px;
                pointer-events: none;
            }

            #menu{
                background-color: rgba(15, 15, 15, 0.9);
                display: none;
                border-radius: 5px;
                width: fit-content;
                position: absolute;
                top: 32px;
                right: 32px;
            }

            #menu>ul{
                list-style: none;
                padding-left: 10px;
                padding-right: 10px;
                margin: 0px;
                min-width: 96px;
            }

            #menu>ul>li{
                border-bottom: 1px solid gray;
                margin-top: 16px;
                margin-bottom: 16px;
                cursor: pointer;
                user-select: none;
            }

            #input_abrir{
                border: 0px;
                width: calc(100% - 14px);
                opacity: 0;
                position: absolute;
            }

            #p_abrir{
                margin: 0px;
                
            }

            .div_ventana{
                display: none;
                background: rgba(15, 15, 15, 0.9);
                border: 1px solid white;
                border-radius: 5px;
                position: fixed;
                padding: 10px;
                top: calc((100vh - 256px) / 2);
                left: calc((100vw - 256px) / 2);
                width: calc(256px - 20px);
                height: calc(256px - 20px);
 	 	        overflow-y: auto;
            }

            #botonesVentana{
                text-align: center;
                margin-top: 10px;
            }

            #botonesVentana>button{
                border: 1px solid red;
                margin: 5px;
                background:rgba(15, 15, 15, 0.9);
                color: white;
                border: 1px solid white;
                border-radius: 5px;
            }

	#inputVentana{
		background: black;
		color: white;
		margin-top: 5px;
	}
            

    #button_menu{
        background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAATklEQVRYR+3UwQ0AIAhDUbr/0GUA4pGUxO/Rg9SXBlX4KDy/CHBPwLa3eiFpfHhcEGCL//XuvRIigEBcgEUUF4h3gAAIIBDfAwSghN8JNMQgJCF5+x2IAAAAAElFTkSuQmCC');
        background-size: cover;
        background-repeat: no-repeat;
        opacity: 0.75;
        
        width: 32px;
        height: 32px;
        position: fixed;
        top: 32px;
        right: 32px;
        border: 1px solid white;
        border-radius: 5px;
        z-index: 20;
    }

            

        </style>

        
        

        <div id="contenedor_principal">
        <div id="enumerador_textarea"></div>
        <div id="contenedor_textarea">
            <textarea spellcheck="false"></textarea>
        </div>
        </div>
        
        <div id="menu">
            <ul>
                <li onclick="nuevo()">Nuevo</li>
                <li id="li_abrir" onclick="ocultar_elementos()"><input id="input_abrir" type="file"><p id="p_abrir">Abrir</p></li>
                <li onclick="visualizar()">Visualizar</li>
                <li onclick="descargar()">Descargar</li>
                <li onclick="deshacer()">Deshacer</li>
                <li onclick="rehacer()">rehacer</li>
                <li onclick="instrucciones()">Instrucciones</li>
            </ul>
        </div>

        

        <div class="div_ventana">
            <p>Instrucciones:</p>
            <div>Presiona dos veces M para abrir menú.</div>
	        <input id="inputVentana" type="text" value="index.html">
            <div id="botonesVentana"><button onclick="aceptar()">Aceptar</button><button onclick="cancelar()">Cancelar</button></div>
        </div>

        <div id="button_menu" onclick="menu_abrir()"></div>

        


       
      









        <script>
 

        let textarea = document.getElementsByTagName("textarea")[0];
        textarea.addEventListener('input', function() {ajustar_textarea();guardarCache();funcion_textoPredictivo();guardarHistorialTextarea()});
        textarea.addEventListener('click', function() {
            ocultar_elementos();
            if(contenedor_textarea.scrollTop<48){scrollTop=0;contenedor_textarea.scrollTop=0}
        });

        

        let memoria = {
            archivos: [{
                index: 0,
                type: "archivo",
                name: "index.html",
                content: ""
            }],
            archivoActual: {
                index: 0,
                type: "archivo",
                name: "index.html",
                content: ""
            },

            textarea: {
                index: 0,
                historial: ['']
            }
        }

        let memoriaDefault =  Object.assign({}, memoria);
        
        function reiniciarCahe(){
            textarea.value = "";
            memoria =  Object.assign({}, memoriaDefault);
            guardarCache();
        }


        function verificarCache(){
            let memoriaCacheString = localStorage.getItem('memoria');
            if (memoriaCacheString) {
                memoria = JSON.parse(memoriaCacheString);
                textarea.value = memoria.archivoActual.content;
            }else{
                reiniciarCahe();
            }
        }

        verificarCache();

        function guardarCache(){
            memoria.archivoActual.content = textarea.value;
		    let index = memoria.archivoActual.index;
            memoria.archivos[index] = Object.assign({}, memoria.archivoActual);
        	let memoriaString = JSON.stringify(memoria);
        	localStorage.setItem('memoria', memoriaString);
        }


        let enumerador_textarea = {
            elemento: document.getElementById("enumerador_textarea"),
            lineas: 100,
	    visible: true
        }
       
        for(let i=1; i<=enumerador_textarea.lineas; i++)
        {
            enumerador_textarea.elemento.innerHTML+=i+"<br>";
        }

        let contenedor_textarea =  document.getElementById("contenedor_textarea");
        
        contenedor_textarea.addEventListener('scroll', function() {
            let scrollTop = event.target.scrollTop;
            
            enumerador_textarea.elemento.scrollTop = scrollTop;
            enumerador_textarea.lineas+=1;
            enumerador_textarea.elemento.innerHTML+=enumerador_textarea.lineas+"<br>";
        });


   	function ocultarEnumerador(){
		if(enumerador_textarea.visible){
			enumerador_textarea.visible=false;
			enumerador_textarea.elemento.style.visibility="hidden";
		}else{
			enumerador_textarea.visible=true;
			enumerador_textarea.elemento.style.visibility="visible";
		}
	}

   	ocultarEnumerador();

        function ajustar_textarea(){
            const content = textarea.value;
            const lines = content.split('\n');
            const longestLine = lines.reduce((max, line) => Math.max(max, line.length), 0);
            const width = longestLine * 12; // Ancho por carácter
            const lineHeight = 32*1.5; // Altura de cada línea (ajustar según sea necesario)
            const height = lines.length * lineHeight; // Altura total

            textarea.style.width = `${width}px`;
            textarea.style.height = `${height}px`;
        }

        ajustar_textarea();

        let menu = {
            element: document.getElementById("menu"),
            abierto: false,
            input_abrir: document.getElementById('input_abrir'),
            button: document.getElementById("button_menu"),
            buttonVisible: true
	}


        function ocultarButtonMenu(){
            if(menu.buttonVisible){
                menu.buttonVisible=false;
                menu.button.style.display="none";
            }else{
                menu.buttonVisible=true;
                menu.button.style.display = "block";
            }
        }

        function menu_abrir(){
            if(menu.abierto)
            {
                menu.abierto=false;
                menu.element.style.display = "none";
            }
            else
            {
                menu.abierto=true;
                menu.element.style.display = "block";

            }}

        function pantallaCompleta(elemento) {
            if (!document.fullscreenElement) {
                if (elemento.requestFullscreen) {
                elemento.requestFullscreen();
                } else if (elemento.webkitRequestFullscreen) {
                elemento.webkitRequestFullscreen();
                } else if (elemento.mozRequestFullScreen) {
                elemento.mozRequestFullScreen();
                } else {
                console.log("El elemento no admite pantalla completa");
                }
            } else {
                try{document.exitFullscreen();}catch(error){try{document.webkitExitFullscreen();}catch(error){try{document.msExitFullscreen();}catch(error){try{document.mozExitFullscreen();}catch(error){console.error("No se pudo salir del modo de pantalla completa");return;}}}}
               }

            }

        function ocultar_elementos(){
            menu.element.style.display="none";
            menu.abierto = false;
            ventana.elemento.style.display="none";
	    ventana.abierta = false;
            textoPredictivo.abierto=false;
        }

        

        menu.input_abrir.addEventListener('change', function(event) {
            let archivo = event.target.files[0];
            if (!archivo) {mensaje_flotante('¡Error! No se ha seleccionado ningún archivo.');return}
            let reader = new FileReader();
            let tipo = archivo.type;
              if (tipo.includes("text") || tipo.includes("application/xml") || tipo.includes("application/json")) {
                    reader.readAsText(archivo);
                } else {
                    mensaje_flotante('Archivo no compatible');return
                }
            reader.onload = function(event) {
                memoria.archivoActual.type =  archivo.type;
                memoria.archivoActual.name =  archivo.name;
                memoria.archivoActual.content =  event.target.result;
                textarea.value = memoria.archivoActual.content;
                guardarCache();
                ajustar_textarea();}});





        function descargar() {
            ventana.estado= "descargar";
            ventana.titulo= "Descargando";
            ventana.contenido= "Nombre de archivo:";
            ventana.inputNombre= true;
            ventana.botones= true;
            ventana.style = ` 
		height: fit-content;
          	width: 256px;`;
            mostrarVentana();
	    } 

        function visualizar(){

	    let vistaPrevia = `

	<!--Edicion-->
	<style>
		#divVistaPrevia{
			position: fixed;
			top: 0px;
			right: 0px;
			background: red;
			border-radius: 5px;
			color: white;
			padding: 5px;
			pointer-events: none;
			opacity: 0.75;
		}
	</style>
	<div id="divVistaPrevia">Vp</div>
	<!--Fin edicion-->`;

            let htmlString = textarea.value;
	    if(htmlString.indexOf("<body>")){
	    htmlString = htmlString.replace("<body>","<body>"+vistaPrevia);
	    }
            const blob = new Blob([htmlString], { type: 'text/html' });
            const urlData = URL.createObjectURL(blob);
            const newWindow = window.open(urlData, '_blank');
            newWindow.addEventListener('load', function() {URL.revokeObjectURL(urlData);});}




        function mensaje_flotante(str) {
            const div = document.createElement('div');
            div.className = 'mensaje_flotante';
            div.style = `position: fixed;background: rgba(12, 11, 11,0.9);border-radius: 5px;color: white;padding: 5px;padding-left: 10px;padding-right: 10px;left: 5px;top: 32px;`;
            div.textContent = str;
            const existingElements = document.querySelectorAll('.mensaje_flotante');
            let topPosition = 32; // Initial bottom position
            if (existingElements.length > 0) {
                const lastElement = existingElements[existingElements.length - 1];
                const lastElementTop = parseInt(lastElement.style.top, 10) || 5; // Default to 5 if no style is set
                topPosition = lastElementTop + 32; 
            }
            div.style.top = `${topPosition}px`;
            document.body.appendChild(div);
            setTimeout(() => {
                document.body.removeChild(div);
            }, 2500);}





        document.addEventListener('keydown', function(event) {

	    if(event.keyCode == 13){
		if(ventana.abierta){
			event.preventDefault();
	 		aceptar();
		}
	    }
            
            if (event.key === 'Tab') {
                event.preventDefault();
                tabular();
            }
        });

        function tabular() {
            if (!textarea.onfocus) {
                textarea.focus(); // Dar foco al textarea si no lo tiene
            }

            const selectionStart = textarea.selectionStart;
            const selectionEnd = textarea.selectionEnd;

            // Crear una cadena con la tabulación
            const tab = '\t';

            // Insertar la tabulación en la posición del cursor
            textarea.value = textarea.value.substring(0, selectionStart) + tab + textarea.value.substring(selectionEnd);

            // Ajustar la posición del cursor después de la tabulación
            textarea.selectionStart = selectionStart + tab.length;
            textarea.selectionEnd = textarea.selectionStart;
        }


















        let dobleClick = {
            cantidad: 0,
            time: 0,
            funciones: {}
        }

        textarea.addEventListener('keydown', function(event) {
            dobleClick.cantidad++;
            if (!dobleClick.time) {
                dobleClick.time = setTimeout(function() {
                if (dobleClick.cantidad> 1) {
                    dobleClickAction();
                }
                clearTimeout(dobleClick.time);
                dobleClick.time = null;
                dobleClick.cantidad = 0;
                dobleClick.tecla = []
                }, 500);
            }

            
        });

        function dobleClickAction(){
            const selectionStart = textarea.selectionStart;
            const selectionEnd = textarea.selectionEnd;
    
            let ultimos_caracteres =  textarea.value.slice(0, textarea.selectionStart).slice(-dobleClick.cantidad);

            
            if(ultimos_caracteres.toUpperCase() in dobleClick.funciones)
            {
                ultimos_caracteres = ultimos_caracteres.toUpperCase();
            }
            else if(ultimos_caracteres.toLowerCase() in dobleClick.funciones)
            {
                ultimos_caracteres = ultimos_caracteres.toLowerCase();
            }else{
                return
            }

            
            textarea.value = textarea.value.substring(0, selectionStart - dobleClick.cantidad) + textarea.value.substring(selectionEnd);
            textarea.selectionStart = selectionStart - dobleClick.cantidad;
            textarea.selectionEnd = selectionStart - dobleClick.cantidad;

            dobleClick.funciones[ultimos_caracteres]();

            guardarCache();
        }

        function asignarAccion(tecla,funcion){
            let index = dobleClick.funciones.length;
            dobleClick.funciones[tecla] = funcion;
        }
    
        asignarAccion("   ",function(){tabular()});
        asignarAccion("mmm",function(){menu_abrir()});
        asignarAccion("vvv",function(){visualizar()});
        asignarAccion("ddd",function(){descargar()});
        asignarAccion("ppp",function(){pantallaCompleta(document.documentElement)});
        asignarAccion("eee",function(){ocultarEnumerador()});
        asignarAccion("iii",function(){instrucciones()});
        asignarAccion("nnn",function(){nuevo()});
        asignarAccion("ooo",function(){ocultarButtonMenu()});



let ventana = {
	    abierta: false,
            elemento: document.getElementsByClassName("div_ventana")[0],
	    style: "",
        }

        ventana.elementos = ventana.elemento.children;



	















        function mostrarVentana(){
	    ventana.abierta = true;
	    ventana.elemento.style = ventana.style;
            ventana.elemento.style.display = "block";
            

            for (let i=0; i<ventana.elementos.length; i+=1){ventana.elementos[i].style.display="none"}
            if(ventana.titulo!=""){
            ventana.elementos[0].style.display = "block";
            ventana.elementos[0].innerHTML = ventana.titulo;}
            if(ventana.contenido!=""){
            ventana.elementos[1].style.display = "block";
            ventana.elementos[1].innerHTML = ventana.contenido;}
            if(ventana.inputNombre){
            ventana.elementos[2].style.display = "block";
            ventana.elementos[2].value = memoria.archivoActual.name;
            }
            if(ventana.botones){
            ventana.elementos[3].style.display = "block";}
        }
    	
		

        
    function instrucciones(){
    ventana.estado = "instrucciones";
    ventana.titulo = "Instrucciones";
    ventana.contenido = `Presiona tres veces las siguientes teclas: <br><br>
    III: Instrucciones<br>
    MMM: Abrir menú<br>
    PPP: Pantalla completa<br>
    Espacio: Tabular<br>
    DDD: Descargar<br>
    EEE: Enumerar lineas<br>
    VVV: visualizar proyecto.<br>
    OOO: Ocultar botón menú.`;
    ventana.inputNombre = false;
    ventana.botones= false;
    ventana.style = `
    background: red;
    height: 256px;
    width: 256px;`;
    mostrarVentana();}

    









        function nuevo(){
            ventana.estado= "nuevo";
            ventana.titulo="Crear nuevo proyecto";
            ventana.contenido="¿Quieres borrar la caché y el proyecto actual para crear un proyecto nuevo?";
            ventana.inputNombre= false;
            ventana.botones=true;
            ventana.style = `
		height: fit-content;
            	width: 256px;`;
            mostrarVentana();
        }

	

        function aceptar(){

	if(ventana.abierta){
            let estado = ventana.estado;
            if(estado=="nuevo") {reiniciarCahe()}

            if(estado=="descargar") {
                const html = textarea.value;
                const dataUrl = `data:text/html;charset=utf-8,${encodeURIComponent(html)}`;
                const enlaceDescarga = document.createElement('a');
                enlaceDescarga.href = dataUrl;
                enlaceDescarga.download = ventana.elementos[2].value;
                enlaceDescarga.click();
            }

	    if(estado=="textoPredictivo") {
		seleccionarTextoPredictivo(0);
	    }
	 }

            ocultar_elementos();
        }

        function cancelar(){ocultar_elementos()}
        






        //-texto predictivo



        let textoPredictivo = {
            abierto: false,
            arreglo: [],
            arregloActual: [],
 	    textoEscrito: "",
            textoSeleccionado: "",
            arreglos: {
                listener: ["click", "dblclick", "mousedown", "mouseup", "mousemove", "mouseover", "mouseout", "keydown", "keyup", "keypress", "focus", "blur", "change", "input", "submit", "error", "abort", "load", "unload", "resize", "scroll", "orientationchange", "touchstart", "touchmove", "touchend", "touchcancel", "gamepadconnected", "gamepaddisconnected"],
                listenerAddEvent: ["addEventListener", "removeEventListener", "dispatchEvent", "target", "currentTarget", "bubbles", "cancelable", "composed", "returnValue", "defaultPrevented", "eventPhase", "timeStamp", "srcElement", "type"],
                etiquetasHtml: ["&lt!DOCTYPEhtml&gt","&lthtml&gt","&lthead&gt","&lttitle&gt","&ltmeta&gt","&ltlink&gt","&ltstyle&gt","&ltscript&gt","&lt/head&gt","&ltbody&gt","&lth1&gt","&lth2&gt","&lth3&gt","&lth4&gt","&lth5&gt","&lth6&gt","&ltp&gt","&ltbr&gt","&lthr&gt","&ltimg&gt","&lta&gt","&ltstrong&gt","&ltem&gt","&ltul&gt","&ltol&gt","&ltli&gt","&ltdl&gt","&ltdt&gt","&ltdd&gt","&ltpre&gt","&ltcode&gt","&ltspan&gt","&ltdiv&gt","&lttable&gt","&ltcaption&gt","&ltthead&gt","&lttbody&gt","&lttfoot&gt","&lttr&gt","&ltth&gt","&lttd&gt","&ltform&gt","&ltlabel&gt","&ltinput&gt","&ltselect&gt","&ltoption&gt","&lttextarea&gt","&ltbutton&gt","&ltiframe&gt","&ltembed&gt","&ltobject&gt","&ltvideo&gt","&ltaudio&gt","&ltmap&gt","&ltarea&gt","&ltcanvas&gt","&ltprogress&gt","&ltmeter&gt","&ltdetails&gt","&ltsummary&gt","&ltmenu&gt","&ltcommand&gt","&ltdatalist&gt","&ltkeygen&gt","&ltoutput&gt","&lttrack&gt","&ltsource&gt"],
                atributosHtml: [  "accesskey",  "align",  "alt",  "archive",  "async",  "autocapitalize",  "autocomplete",  "autofocus",  "autoplay",  "background",  "bgcolor",  "border",  "buffered",  "challenge",  "charset",  "checked",  "cite",  "class",  "cols",  "colspan",  "content",  "contenteditable",  "controls",  "coords",  "crossorigin",  "csp",  "currentitem",  "data",  "datalist",  "datetime",  "default",  "defer",  "disabled",  "download",  "draggable",  "dropzone",  "enctype",  "enterkeyhint",  "face",  "for",  "form",  "formaction",  "formenctype",  "formmethod",  "formtarget",  "frameborder",  "headers",  "height",  "hidden",  "high",  "hspace",  "icon",  "id",  "incremental",  "indeterminate",  "ismap",  "key",  "keydown",  "keypress",  "keyup",  "lang",  "language",  "lazyload",  "length",  "list",  "loop",  "low",  "max",  "maxlength",  "minlength",  "multiple",  "muted",  "name",  "nav",  "nonce",  "noscript",  "nowrap",  "open",  "optimum",  "order",  "orient",  "outerHTML",  "outerText",  "padding",  "page",  "pageincrement",  "pagemax",  "pagemin",  "pageside",  "pagesize",  "panel",  "placeholder",  "ping",  "play",  "poster",  "preload",  "profile",  "prompt",  "public",  "query",  "radiogroup",  "readonly",  "referrerpolicy",  "rel",  "remote",  "required",  "resize",  "reversed",  "rows",  "rowspan",  "sandbox",  "scope",  "screen",  "scriptable",  "seamless",  "selected",  "selectiondirection",  "size",  "sizes",  "slot",  "sortable",  "source",  "spellcheck",  "src",  "srcdoc",  "srclang",  "standby",  "start",  "status",  "style",  "summary",  "TabIndex",  "target",  "textarea",  "text",  "title",  "to",  "translate",  "type",  "ultralong",  "unicode",  "usemap",  "value",  "var",  "version",  "verticalalign",  "viewbox",  "visible",  "width",  "wrap",  "wrongtext"],
                varios: ["&ltmeta name='viewport' content='width=device-width, initial-scale=1.0'>","data:image/png;base64,[BASE64_IMAGE]","lang='es'","<meta charset='utf-8'>","document","getElementById","getElementsByTagName","getElementsByClassName","children","src","href","bottom","function","link","rel", "onclick"],
                cssKeywords:["absolute","align-content","align-items","align-self","all","alternate","animation","animation-delay","animation-direction","animation-duration","animation-fill-mode","animation-iteration-count","animation-name","animation-play-state","animation-timing-function","appearance","aspect-ratio","auto","background","background-attachment","background-blend-mode","background-clip","background-color","background-image","background-origin","background-position","background-repeat","background-size","backface-visibility","balance","baseline","before","border","border-bottom","border-bottom-color","border-bottom-left-radius","border-bottom-right-radius","border-bottom-style","border-bottom-width","border-collapse","border-color","border-image","border-image-source","border-image-slice","border-image-width","border-image-repeat","border-inline","border-inline-color","border-inline-end","border-inline-end-radius","border-inline-start","border-inline-start-radius","border-inline-style","border-inline-width","border-left","border-left-color","border-left-radius","border-left-style","border-left-width","border-radius","border-right","border-right-color","border-right-radius","border-right-style","border-right-width","border-spacing","border-style","border-top","border-top-color","border-top-left-radius","border-top-right-radius","border-top-style","border-top-width","border-width","bottom","box-decoration-break","box-decoration-line","box-decoration-style","box-shadow","box-sizing","break-after","break-before","break-inside","calc","caption","caret-color","center","character-range","character-set","clear","clip","clip-path","color","column-count","column-fill","column-gap","column-rule","column-rule-color","column-rule-style","column-rule-width","columns","content","counter-increment","counter-reset","cursor","data","direction","display","drop-shadow","element","empty-cells","fill","filter","flex","flex-basis","flex-direction","flex-flow","flex-grow","flex-shrink","flex-wrap","float","font","font-family","font-feature-settings","font-kerning","font-language-overrides","font-light","font-line-height","font-margin","font-max-lines","font-optical-size-adjust","font-palette","font-size","font-size-adjust","font-slant","font-style","gap","grid","grid-area","grid-auto-columns","grid-auto-flow","grid-auto-rows","grid-column","grid-column-gap","grid-column-start","grid-column-end","grid-content","grid-gap","grid-layout","grid-line","grid-row","grid-row-gap","grid-row-start","grid-row-end","grid-template","grid-template-areas","grid-template-columns","grid-template-rows","hanging-punctuation","height","hidden","highlight","hyphenation","icon","image-orientation","image-rendering","image-set","initial","inline","inline-block","inline-flex","inline-grid","input","inset","isolation","justify-content","justify-items","justify-self","kerning","left","letter-spacing","line-break","line-height","linear-gradient","list-style","list-style-image","list-style-position","list-style-type","local","look-ahead","low","margin","margin-bottom","margin-left","margin-right","margin-top","marker","marker-align","marker-offset","marker-orientation","mask","mask-border","mask-border-mode","mask-border-slice","mask-clip","mask-composite","mask-image","mask-mode","mask-origin","mask-position","mask-repeat","mask-size","max","max-content","max-height","max-inline-size","max-width","min","min-content","min-height","min-inline-size","min-width","mix-blend-mode","move-to-edge","multiple","nav","negative","newline-in-hinti","no-display","normal","not-normal","object-fit","object-position","opacity","order","orphan","outline","outline-color","outline-offset","outline-style","outline-width","overflow","overflow-x","overflow-y","padding","padding-bottom","padding-left","padding-right","padding-top","page","page-break-after","page-break-before","page-break-inside","page-size","paint-order","palettes","perspective","perspective-origin","pointer-events","position","post-hyphens","pre","pre-break","pre-wrap","print","progress","proportions","pseudo","punctuation","radial-gradient","range","ratio","reattachment","reflect","reflow","region","relative","repeat","repeating-linear-gradient","resize","rest","revert","revolution","right","rotation","scrollbar-color","scrollbar-width","scroll-behavior","scroll-edge-distance","scroll-logical-position","scroll-margin","scroll-padding","scroll-snap-align","scroll-snap-destination","scroll-snap-points","scroll-snap-type","scroll-top","scroll-zoom","selection","shape-image-type","shape-margin","shape-outside","shape-padding","size","speak-as-coordinates","speak-numerals","speak-punctuation","speech-level","src","status","stretch","stroke","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke-width","style","sub","super","table-caption","table-cell","table-column","table-footer","table-header","table-layout","table-row","tab-size","target","text","text-align","text-align-last","text-decoration","text-decoration-color","text-decoration-line","text-decoration-style","text-decoration-thickness","text-indent","text-justify","text-line-break","text-overflow","text-rendering","text-shadow","text-size-adjust","text-transform","text-underline-position","text-wrap","timing-functions","top","transform","transform-box","transform-origin","transform-style","transition","transition-delay","transition-duration","transition-property","transition-timing-function","translate","translate3d","turn","underline","unset","url","user-select","var","vertical-align","vertical-hanging-punctuation","visibility","white-space","widows","width","word-break","word-spacing","wrap-flow","wrap-margin","writing-mode","z-index"],
                cssColors: ["black","white","red","green","blue","yellow","orange","purple","pink","fuchsia","teal","cyan","magenta","lime","olive","maroon","navy","gray","silver","gold","brown","transparent","darkred","darkgreen","darkblue","lightskyblue","royalblue","lightcoral","coral","tomato","darkviolet","lightgreen","darkgoldenrod","lightgoldenrodyellow",],
                javascriptKeywords:["abstract","arguments","await","boolean","break","byte","case","catch","class","const","continue","debugger","default","delete","do","else","enum","export","extends","false","finally","float","for","function","goto","if","implements","import","in","instanceof","interface","int","let","logical","null","number","of","package","private","protected","public","readonly","return","short","signed","static","super","switch","synchronized","this","throw","throws","true","try","typeof","undefined","var","void","volatile","while","with","yield","add","addEventListener","alert","all","anchor","animation","apply","Array","arguments","assign","async","atob","attachEvent","auto","backgroundColor","backgroundImage","backgroundPosition","backgroundRepeat","backgroundSize","Behavior","before","beginUpdate","beginPath","bezierCurveTo","big","bind","blob","blur","body","Boolean","borderColor","borderBottom","borderBox","borderCollapse","borderRadius","borderImage","borderLeft","borderLineStyle","borderPadding","borderRight","borderSpacing","BorderStyle","borderTop","borderWidth","boxShadow","break","buffer","button","byteLength","C","cache","call","caller","cancelAnimationFrame","canvas","captureEvents","case","catch","ceil","clearInterval","clearTimeout","center","charAt","charCodeAt","charCode","checked","childElementCount","childNodes","classList","click","clearInterval","clearTimeout","close","charCodeAt","collapse","color","cols","colgroup","command","Comment","compareDocumentPosition","complete","concat","conditional","confirm","connect","connected","connection","console","constructor","contains","content","contentWindow","context","control","coordinates","copy","cos","count","createAttribute","createCDATASection","createElement","createDocumentFragment","createEvent","createLSInput","createLSOutput","createNSResolver","createTextNode","createXPath","crossOrigin","CSS","CSSOM","crypto","cssText","currentTarget","customElements","data","dataset","Date","decodeURI","decodeURIComponent","defaultValue","defer","deleteRow","deleteCell","depth","detachEvent","dispatchEvent"],
                javascriptControlStructures: ["if","else","elseif","switch","case","default","ternaryoperator","for","while","do-while","for...in","for...of","break","continue","try","catch","finally","label","goto"],
                selectElementMethods: ["getElementById","getElementsByTagName","getElementsByClassName","querySelector","querySelectorAll","Element.querySelector","Element.querySelectorAll","Element.closest","Element.matches",],
            }

        }

        function integrarArreglos() {
            const arregloPrincipal = textoPredictivo.arreglo; // Referencia al arreglo principal
            for (const propiedad in textoPredictivo.arreglos) {
                if (Array.isArray(textoPredictivo.arreglos[propiedad])) {
                    const arregloAnidado = textoPredictivo.arreglos[propiedad]; // Referencia al arreglo anidado
                    for (const elemento of arregloAnidado) {
                        arregloPrincipal.push(elemento); // Agregar elemento al arreglo principal
                    }
                }
            }
        }

        integrarArreglos();

        function funcion_textoPredictivo(){
            let textoPresente = textarea.value.substr(0,textarea.selectionStart);
            textoPredictivo.textoEscrito = ultimaPalabraEscrita2(textoPresente);
            let palabra = textoPredictivo.textoEscrito;
            let ultimoCaracter = f_ultimoCaracter(textoPresente);
            if(palabra.length){
                if(caracterPermitido(ultimoCaracter)){
                    let arregloSalida = encontrarCoincidencias(palabra,textoPredictivo.arreglo);
                    if(arregloSalida.length>0)
                    {
                        textoPredictivo.arregloActual = copiarArreglo(arregloSalida);
                        let contenido = "<ul style='list-style: none; padding: 0px; margin:0px;'>";
                        for(let i=0; i<arregloSalida.length; i++)
                        {
                            contenido+=`<li style='margin-bottom: 10px; margin-top: 10px; cursor: pointer;' onclick='seleccionarTextoPredictivo(`+i+`)'>`+arregloSalida[i]+"</li>";
                        }
                        contenido+="</ul>";

                        textoPredictivo.abierto=true;
                        ventana.estado= "textoPredictivo";
                        ventana.titulo="";
                        ventana.contenido=contenido;
                        ventana.inputNombre= false;
                        ventana.botones=false;
                        ventana.style = `
                        background: blue;
                        height: fit-content;
                        max-height: 64px;
                        overflow-y: auto;
                        width: fit-content;
                        top: auto;
                        left: 2px;
                        bottom: 2px;
                        padding: 5px;
                        `;
                        mostrarVentana();
                        return
                    }
                    else
                    {
                        ocultar_elementos();
                    }

                    return
                }
            }
            ocultar_elementos();
        }
       
        function seleccionarTextoPredictivo(index){
		let textoEscrito = textoPredictivo.textoEscrito;
		let length = textoEscrito.length;
	    let palabraCorregida = cambiarEntidades(textoPredictivo.arregloActual[index]);
		const selectionStart = textarea.selectionStart;
   		const selectionEnd = textarea.selectionEnd;
    
		// Insertar la palabra en la posición del cursor
            	textarea.value = textarea.value.substring(0, selectionStart-length) + palabraCorregida + textarea.value.substring(selectionEnd);
		ocultar_elementos();	
 		textarea.selectionStart=selectionStart - length + palabraCorregida.length;
		textarea.selectionEnd= textarea.selectionStart;
		textarea.focus();
            }

        function cambiarEntidades(texto) {const entidades = {"&lt":"<","&gt":">","&amp":"&","&quot":"\"","&apos":"'"};for (const entidad in entidades) while (texto.includes(entidad)) texto = texto.replace(entidad, entidades[entidad]);return texto;}



        //Funciones utiles:
        function ultimaPalabraEscrita(str) {str = str.trim();const palabras = str.split(' ');if (palabras.length === 0) {return "";}return palabras[palabras.length - 1];}
        function f_ultimoCaracter(cadena) {return cadena[cadena.length - 1]}//ultimo caracter de una cadena
        function caracterPermitido(str) {str = str.trim();const ultimoCaracter = str.charAt(str.length - 1);const caracteresNoPermitidos = " .\n"; return !caracteresNoPermitidos.includes(ultimoCaracter)}
        function strExisteEnArregloSome(str, arreglo){return arreglo.some(elemento => elemento === str)}//si existe en arreglo
        function existeClaveObjeto(strClave, objeto) {return strClave in objeto}
        function cantidadClavesObjeto(objeto) {return Object.keys(objeto).length;}
        function arregloClavesObjeto(objeto) {return Object.keys(objeto)}
        function organizarArreglo(arreglo) {return arreglo.sort((a, b) => a.localeCompare(b))}
        function sortearArreglo(arreglo) {const longitud = arreglo.length;for (let i = longitud - 1; i > 0; i--) {const j = Math.floor(Math.random() * (i + 1));[arreglo[i], arreglo[j]] = [arreglo[j], arreglo[i]];}return arreglo;}

        function encontrarCoincidencias(str, arregloEntrada) {
            let arregloEntradaCopia = copiarArreglo(arregloEntrada);
            const arregloSalida = [];
            for (let i = 0; i < arregloEntrada.length; i++) 
            {
            const elementoActual = arregloEntrada[i].toLowerCase();
            if (elementoActual.includes(str.toLowerCase())) 
            {arregloSalida.push(arregloEntrada[i]);}
            }return arregloSalida;}

        function ultimaPalabraEscrita2(str) {str = str.trim();const palabras = str.split(/\s+|\./);if (palabras.length === 0) {return ""};return palabras[palabras.length - 1]}
        function copiarArreglo(arreglo){return arreglo.slice()}
        function copiarObjeto(objeto) {return Object.assign({}, objeto)}


        function recortarArreglo(index, arreglo) {
            if (index < 0 || index > arreglo.length) {
                throw new Error("Index out of bounds");
            }
            return arreglo.slice(0, index + 1); 
        }

        function actualizarArreglo(array, nuevoElemento) {
            array.push(nuevoElemento);
            array.shift();
        }

        function deshacer() {
            memoria.textarea.index-=1;
            if(memoria.textarea.index<0){memoria.textarea.index=0}
            textarea.value = memoria.textarea.historial[memoria.textarea.index];
        }

        function rehacer() {
            memoria.textarea.index+=1;
            if(memoria.textarea.index>memoria.textarea.historial.length-1){
            memoria.textarea.index=memoria.textarea.historial.length-1}
            textarea.value = memoria.textarea.historial[memoria.textarea.index];
        }

        function guardarHistorialTextarea(){
            if(memoria.textarea.index!=9)
            {
                if(memoria.textarea.historial.length>memoria.textarea.index)
                {
                    console.log("recortar")
                    memoria.textarea.historial = recortarArreglo(memoria.textarea.index, memoria.textarea.historial);
                }
                
                memoria.textarea.historial.push(textarea.value);
                memoria.textarea.index = memoria.textarea.historial.length-1;
            }
            else
            {
                actualizarArreglo(memoria.textarea.historial,textarea.value);
            }
            console.log(memoria.textarea.historial);
        }

        guardarHistorialTextarea();











        </script>




	

        




    </body>
</html>